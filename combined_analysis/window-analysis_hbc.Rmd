---
title: "Window analysis with LM/Ms"
author: "Thejasvi Beleyur"
date: "3/4/2021"
bibliography: analysis-refs.bib
output: html_document

---

# TODO : 
1. include virtual multi-bat groups wherever possible in the 
1. compile all results into one table

This notebook will detail the use of bayesian linear models and mixed models to 
quantify the difference between single and multi-bat call properties. The final results are presented in the [Parameter Summary](#paramsummary). This notebook analyses the difference in:
1. [Window received level](#reclevel)
1. [FM lower frequency](#fmlower)
1. [Dominant frequency range](#domfreq)

The linear mixed models used in the following analysis used a non-informative prior. All intervals reported here are 93% highest posterior density compatibility intervals [@gelman2019confidence;@mcelreath2020statistical]. The compatibility interval corresponds to the estimate-interval that best explains the *current dataset*. This is in contrast to frequentist confidence intervals which produce a 'long-term' interval, without guarantee that the estimate is within the confidence interval at hand. 

```{r loading, echo=T, warning=F,message=F,results='hide'}

library(arm)
library(coda)
library(lme4)
library(stringi)
library(stringr)
set.seed(82319)
# number of simulations to get from the posterior distribution
num_post <- 5000
# convenience function 
get.hpd <- function(x,prange=0.93){HPDinterval(as.mcmc(x),prob=prange)}


# let's load the split-measure data from the whole audio analysis 
obs_splitmeasure_raw = read.csv('../annotation_audio_analysis/analysis/obs_nonsilent_measurements_20dBthreshold_wcentdomfreqs.csv')
obs_splitmeasure_timestamp <- read.csv('./obs_splitmeasure_wtimestamp.csv')

obs_splitmeasure_timestamp$group_status <- obs_splitmeasure_timestamp$num_bats>1

virt_splitmeasure = read.csv('../annotation_audio_analysis/analysis/virt_nonsilent_measurement_20dBthreshold_wcentdomfreqs.csv')
virt_splitmeasure$group_status <- virt_splitmeasure$num_bats>1
virt_splitmeasure$video_annot_id <- sapply(virt_splitmeasure$video_annot_id,function(X){paste('virt_',X)}) # make them all into virtual by add 

# rescale posix timestmap  and convert to minutes
obs_splitmeasure_timestamp$centred_posix_minute <- (obs_splitmeasure_timestamp$posix_timestamp - mean(obs_splitmeasure_timestamp$posix_timestamp))/60.0

# RMS data
obs_reclevel <- subset(obs_splitmeasure_timestamp, measurement=='rms')
virt_reclevel <- subset(virt_splitmeasure, measurement=='rms')
obs_reclevel$dbrms <- 20*log10(obs_reclevel$value)
virt_reclevel$dbrms <- 20*log10(virt_reclevel$value)

# Lower frequency data
obs_lowerfreq <- subset(obs_splitmeasure_timestamp, measurement=='fm_terminal_freqs')
virt_lowerfreq <- subset(virt_splitmeasure, measurement=='fm_terminal_freqs')
# convert frequency to kHz
obs_lowerfreq$lowerfreqkhz <- obs_lowerfreq$value*10^-3
virt_lowerfreq$lowerfreqkhz <- virt_lowerfreq$value*10^-3

# Dominant frequency data
obs_domfreq <- subset(obs_splitmeasure_timestamp, measurement=='dominant_frequencies')
virt_domfreq <- subset(virt_splitmeasure, measurement=='dominant_frequencies')
obs_domfreq$domfreq <- obs_domfreq$value*10^-3
virt_domfreq$domfreq <- virt_domfreq$value*10^-3

# - calculate the max-min range of dominant frequencies within one annotation audio. 
calc.domf.range <- function(df){
          if (length(obs_domfreq$domfreq)>1){
                    c(max(df$domfreq)-min(df$domfreq),unique(df$group_status))
          }
          else {c(0,unique(df$group_status))}
          }
obs_domfrange.raw  <- by(obs_domfreq, obs_domfreq$video_annot_id, calc.domf.range)
obs_domfrange <- as.data.frame(do.call(rbind, obs_domfrange.raw))
colnames(obs_domfrange) <- c('domfrange','multi_bat')

# assign the centred posix minute to each annotation 
obs_domfrange$video_annot_id <- row.names(obs_domfrange)
obs_domfrange$centred_posix_minute <- NA
i = 1
for (each in row.names(obs_domfrange))
  {
  obs_domfrange$centred_posix_minute[i] <- unique(subset(obs_domfreq, video_annot_id==each)$centred_posix_minute)
  i <- i+1
  }
colnames(obs_domfrange)[2] <- 'group_status'
obs_domfrange$group_status <- as.factor(obs_domfrange$group_status)

virt_domfrange.raw  <- by(virt_domfreq, virt_domfreq$video_annot_id, calc.domf.range)
virt_domfrange <- as.data.frame(do.call(rbind, virt_domfrange.raw))
colnames(virt_domfrange) <- c('domfrange','group_status')
virt_domfrange$group_status <- 2
```

## Received level : RMS {#reclevel}

And now build the simplest model that will account for the expected auto-correlation in segments, windows and time in general. 
```{r reclevel-model, warning=F}
obs_reclevel$sqrtdbrms <- sqrt(abs(min(obs_reclevel$dbrms))+obs_reclevel$dbrms)
obsrec.m1 <- lmer(sqrtdbrms ~ group_status + centred_posix_minute+(1|video_annot_id), data=obs_reclevel)
raneffects.m1 <- ranef(obsrec.m1)$video_annot_id$'(Intercept)'
par(mfrow=c(2,2))
scatter.smooth(obs_reclevel$centred_posix_minute,resid(obsrec.m1))
scatter.smooth(obs_reclevel$group_status,resid(obsrec.m1))
qqnorm(resid(obsrec.m1));qqline(resid(obsrec.m1))
qqnorm(raneffects.m1);qqline(raneffects.m1)

```
```{r reclevel-model2, warning=F}
obsrec.m2 <- lmer(sqrtdbrms ~ group_status + (1|video_annot_id), data=obs_reclevel)
raneffects.m2 <- ranef(obsrec.m2)$video_annot_id$'(Intercept)'
par(mfrow=c(2,2))
scatter.smooth(obs_reclevel$centred_posix_minute,resid(obsrec.m2))
scatter.smooth(obs_reclevel$group_status,resid(obsrec.m2))
qqnorm(resid(obsrec.m2));qqline(resid(obsrec.m2))
qqnorm(raneffects.m2);qqline(raneffects.m2)
```


```{r obsrec.sim}
obsrec.m1.sim <- sim(obsrec.m1, n.sim=num_post)
m1.hpd.fixefs <- apply(fixef(obsrec.m1.sim),2,get.hpd)
obsrec.m2.sim <- sim(obsrec.m2, n.sim=num_post)
m2.hpd.fixefs <- apply(fixef(obsrec.m2.sim),2,get.hpd)

# the AIC of model 2 is much lower + the interpretability is more straightforward. 
print(paste('Model 1: ',round(AIC(obsrec.m1),2), sep=' '))
print(paste('Model 2: ',round(AIC(obsrec.m2),2), sep=' '))

# remember to square the predictions to get the units back to dB from sqrt(dB)
single.reclevel <- fixef(obsrec.m2.sim)[,1]^2-abs(min(obs_reclevel$dbrms))
multi.reclevel <- (fixef(obsrec.m2.sim)[,1]+fixef(obsrec.m2.sim)[,2])^2- abs(min(obs_reclevel$dbrms))
hpd.single.reclevel <- round(get.hpd(single.reclevel),0)
hpd.multi.reclevel <- round(get.hpd(multi.reclevel),0)
# the final expected multi-single rec-level difference in dB
hpd.multi.single.diffrec <- round(get.hpd(multi.reclevel-single.reclevel),1)
```

The mean received level of single-bat windows is `r hpd.single.reclevel` dB, and multi-bat windows is `r hpd.multi.reclevel` dB. 
The difference betweeen multi-single bat windows is `r hpd.multi.single.diffrec` dB.

### with virtual bat audio 

```{r reclevelw.virtual , warning=F}
obs_reclevel_subset <- obs_reclevel[,c('segment_number','dbrms','sqrtdbrms','group_status','video_annot_id')]
obs_reclevel_subset$group_status <- as.factor(obs_reclevel_subset$group_status*1)
virt_reclevel_subset <- virt_reclevel[,c('segment_number','dbrms','video_annot_id')]

virt_reclevel_subset$sqrtdbrms <- sqrt(abs(min(obs_reclevel$dbrms))+virt_reclevel_subset$dbrms)
virt_reclevel_subset$group_status <- as.factor(2)
obsvirt_reclevel <- rbind(obs_reclevel_subset, virt_reclevel_subset)
obsvirt_reclevel
```

```{r m3.reclevel, warning=F}
obsrec.m3 <- lmer(sqrtdbrms ~ group_status + (1|video_annot_id), data=obsvirt_reclevel)
raneffects.m3 <- ranef(obsrec.m3)$video_annot_id$'(Intercept)'
par(mfrow=c(2,2))
#scatter.smooth(obsvirt_reclevel$centred_posix_minute,resid(obsrec.m3))
scatter.smooth(obsvirt_reclevel$group_status,resid(obsrec.m3))
qqnorm(resid(obsrec.m3));qqline(resid(obsrec.m3))
qqnorm(raneffects.m3);qqline(raneffects.m3)
```

```{r run.m3}
obsrec.m3.sim <- sim(obsrec.m3, n.sim=num_post)
m3.hpd.fixefs <- apply(fixef(obsrec.m3.sim),2,get.hpd)

print(paste('Model 2: ',round(AIC(obsrec.m3),2), sep=' '))

# remember to square the predictions to get the units back to dB from sqrt(dB)
single.reclevel <- fixef(obsrec.m3.sim)[,1]^2-abs(min(obs_reclevel$dbrms))
multi.reclevel <- (fixef(obsrec.m3.sim)[,1]+fixef(obsrec.m3.sim)[,2])^2- abs(min(obs_reclevel$dbrms))
virt.reclevel <- (fixef(obsrec.m3.sim)[,1]+fixef(obsrec.m3.sim)[,3])^2- abs(min(obs_reclevel$dbrms))
hpd.single.reclevel <- round(get.hpd(single.reclevel),0)
hpd.multi.reclevel <- round(get.hpd(multi.reclevel),0)
hpd.virt.reclevel <- round(get.hpd(virt.reclevel),0)
# the final expected multi-single rec-level difference in dB
hpd.multi.single.diffrec <- round(get.hpd(multi.reclevel-single.reclevel),1)
hpd.virt.multi.diffrec <- round(get.hpd(multi.reclevel-virt.reclevel),1)
```
Including the virtual audio window measurements into the analysis tells us that the received levels don't differ very much between 
1. Multi-single : the 93%ile HPD interval of the mean difference is `r hpd.multi.single.diffrec[1]`-`r hpd.multi.single.diffrec[2]` dB
1. Multi-virtual multi : the 93%ile HPD interval of the mean difference is `r hpd.virt.multi.diffrec[1]`-`r hpd.virt.multi.diffrec[2]` dB


## FM lower frequency {#fmlower}

```{r fmlowerfreq}
obslowerfreq.nona <- obs_lowerfreq[!is.na(obs_lowerfreq$lowerfreqkhz),]
obslower.m1 <- lmer(lowerfreqkhz ~ group_status + centred_posix_minute+(1|video_annot_id), data=obslowerfreq.nona)
obslower.m2 <- lmer(lowerfreqkhz ~ group_status + (1|video_annot_id), data=obslowerfreq.nona)
raneffects.m1 <- ranef(obslower.m1)$video_annot_id$'(Intercept)'
raneffects.m2 <- ranef(obslower.m2)$video_annot_id$'(Intercept)'

par(mfrow=c(2,2))
scatter.smooth(obslowerfreq.nona$centred_posix_minute,resid(obslower.m1))
scatter.smooth(obslowerfreq.nona$group_status,resid(obslower.m1))
qqnorm(resid(obslower.m1));qqline(resid(obslower.m1))
qqnorm(raneffects.m1);qqline(raneffects.m1)

frame()
par(mfrow=c(2,2))
scatter.smooth(obslowerfreq.nona$centred_posix_minute,resid(obslower.m2))
scatter.smooth(obslowerfreq.nona$group_status,resid(obslower.m2))
qqnorm(resid(obslower.m2));qqline(resid(obslower.m2))
qqnorm(raneffects.m2);qqline(raneffects.m2)

```
Both model regressions seem to broadly meet the normality and independence assumptions, with a few very off-residuals. I will run the models with high residual points included and excluded to see if they have a strong effect or not. I will choose Model 2 as it is a simpler model, and has a lower AIC (`r round(AIC(obslower.m1),0)`) (albeit not very different from that of Model 1 : (`r round(AIC(obslower.m2),0)`)). 

```{r sim.obslowerm2}
obslower.m2.sim <- sim(obslower.m2, n.sim=num_post)

lowerm2.hpd.fixefs <- apply(fixef(obslower.m2.sim),2,get.hpd)

single.lower <- fixef(obslower.m2.sim)[,1]
multi.lower <- fixef(obslower.m2.sim)[,1]+fixef(obslower.m2.sim)[,2]
hpd.single.lower <- round(get.hpd(single.lower),2)
hpd.multi.lower <- round(get.hpd(multi.lower),2)
hpd.multi.single.lowerdiff <- round(get.hpd(multi.lower-single.lower),2)
hpd.multi.single.lower.ratio <- round(get.hpd(multi.lower/single.lower),3)
```
Results for *all* data suggest a general decrease of between `r hpd.multi.single.lowerdiff[1]`-`r hpd.multi.single.lowerdiff[2]` kHz of multi-bat FM lower frequencies in comparison to single bat calls. This corresponds to a relative ratio of between `r hpd.multi.single.lower.ratio[1]`-`r hpd.multi.single.lower.ratio[2]` with reference to single bat calls. Overall, it suggests a great similarity in FM lower frequencies. 

```{r sim.obslowerm2.lowresiduals}
# this chunk checks if the estimates still hold true when the large residuals are removed from the data. 
# Let's remove all residuals that are out of the 90%ile residual range. 
pctile.range <- 0.90
left.point <- (1-pctile.range)*0.5
pctile.points <- c(left.point, 1-left.point)
m2.general.residuals <- max(abs(quantile(resid(obslower.m2),pctile.points)))
m2.rows.lowres.points <- abs(resid(obslower.m2)) < m2.general.residuals
m2.lower.lowres.points <- obslowerfreq.nona[m2.rows.lowres.points,]

# fit Model 1 with the subset 
obslower.m2b <- lmer(lowerfreqkhz ~ group_status + (1|video_annot_id),
                     data=m2.lower.lowres.points)

frame()
par(mfrow=c(2,2))
scatter.smooth(m2.lower.lowres.points$centred_posix_minute,resid(obslower.m2b))
scatter.smooth(m2.lower.lowres.points$group_status,resid(obslower.m2b))
qqnorm(resid(obslower.m2b));qqline(resid(obslower.m2b))
qqnorm(raneffects.m2);qqline(raneffects.m2)
```

Having filtered out points that don't give very large residuals, let's now check if the estimates are still more or less that same. 

```{r m2bb.lower.sim}
obslower.m2b.sim <- sim(obslower.m2b, n.sim=num_post)

lowerm2b.hpd.fixefs <- apply(fixef(obslower.m2b.sim),2,get.hpd)

single.lower.b <- fixef(obslower.m2b.sim)[,1]
multi.lower.b <- fixef(obslower.m2b.sim)[,1]+fixef(obslower.m2b.sim)[,2]
hpd.single.lower.b <- round(get.hpd(single.lower),2)
hpd.multi.lower.b <- round(get.hpd(multi.lower),2)
hpd.multi.single.lowerdiff.b <- round(get.hpd(multi.lower.b-single.lower.b),2)
hpd.multi.single.lower.ratio.b <- round(get.hpd(multi.lower.b/single.lower.b),3)

```
Results for *all* data suggest a general decrease of between `r hpd.multi.single.lowerdiff.b[1]`-`r hpd.multi.single.lowerdiff.b[2]` kHz of multi-bat FM lower frequencies in comparison to single bat calls. This corresponds to a relative ratio of between `r hpd.multi.single.lower.ratio.b[1]`-`r hpd.multi.single.lower.ratio.b[2]` with reference to single bat calls. Overall, it suggests a great similarity in FM lower frequencies. 


*The overall results seem to be the same for FM lower frequency, despite the few points that aren't predicted well by the model*

### Including virtual multi-bat audio in 


```{r lowerfreq.virt}
obslowerfreq.nona_subset <- obslowerfreq.nona[,c('segment_number','lowerfreqkhz','group_status','video_annot_id')]
obslowerfreq.nona_subset$group_status <- as.factor(obslowerfreq.nona_subset$group_status*1)
virt_lowerfreq_subset <- virt_lowerfreq[,c('segment_number','lowerfreqkhz','video_annot_id')]
virt_lowerfreq_subset$group_status <- as.factor(2)
obsvirt_lowerfreq <- rbind(obslowerfreq.nona_subset, virt_lowerfreq_subset)
obsvirt_lowerfreq <- obsvirt_lowerfreq[!is.na(obsvirt_lowerfreq$lowerfreqkhz),]
obsvirt_lowerfreq
```


```{r model.lowerfreq.virt,warning=F}
obslower.m3 <- lmer(lowerfreqkhz ~ group_status + (1|video_annot_id), data=obsvirt_lowerfreq)
raneffects.m3 <- ranef(obslower.m3)$video_annot_id$'(Intercept)'

frame()
par(mfrow=c(2,2))
#scatter.smooth(obsvirt_lowerfreq$centred_posix_minute,resid(obslower.m3))
scatter.smooth(obsvirt_lowerfreq$group_status,resid(obslower.m3))
qqnorm(resid(obslower.m3));qqline(resid(obslower.m3))
qqnorm(raneffects.m3);qqline(raneffects.m3)
```

```{r lowerfreq.coefs}
obslower.m3b.sim <- sim(obslower.m3, n.sim=num_post)

lowerm3b.hpd.fixefs <- apply(fixef(obslower.m3b.sim),2,get.hpd)

single.lower.b <- fixef(obslower.m3b.sim)[,1]
multi.lower.b <- fixef(obslower.m3b.sim)[,1]+fixef(obslower.m3b.sim)[,2]
virt.lower.b <- fixef(obslower.m3b.sim)[,1]+fixef(obslower.m3b.sim)[,3]


hpd.single.lower.b <- round(get.hpd(single.lower.b),2)
hpd.multi.lower.b <- round(get.hpd(multi.lower.b),2)
hpd.virt.lower.b <- round(get.hpd(virt.lower.b),2)

hpd.multi.single.lowerdiff.b <- round(get.hpd(multi.lower.b-single.lower.b),2)
hpd.multi.virt.lowerdiff.b <- round(get.hpd(multi.lower.b-virt.lower.b),2)
```
Here we see that the lower-frequencies of single, multi and virtual-multi bat audio windows are very similar:
  1. Multi-single lower-frequency : the difference is in the range of `r hpd.multi.single.lowerdiff.b[0]`-`r hpd.multi.single.lowerdiff.b[1]` kHz
  1. Multi-virtual multi lower-frequency : the difference is in the range of `r hpd.multi.virt.lowerdiff.b[0]`-`r hpd.multi.virt.lowerdiff.b[1]` kHz


## Dominant frequency range {#domfreq}

Here we won't be using the video annotation ID as a 

```{r domfreq}
obs_domfrange$sqrt.frange <- sqrt(obs_domfrange$domfrange)
virt_domfrange$sqrt.frange <- sqrt(virt_domfrange$domfrange)
obsdomf.m2 <- lm(sqrt.frange ~ group_status + centred_posix_minute , data=obs_domfrange)

par(mfrow=c(3,2))
plot(obsdomf.m2)
acf(resid(obsdomf.m2))


```

Here we won't be using video annotation ID as a random intercept as there is only measurement per annotation ID. Instead I have included time as a predictor, and also present the auto-correlation of the residuals to pick up on any correlation in residuals. The autocorrelation plot suggests there is no reason to be concerned about correlation in the data. The residuals aren't too ideal, but they're also not too bad either?


```{r obsdomf.sim}

obsdomf.m2.sim <- sim(obsdomf.m2, n.sim=num_post)
m2.domf.hpd.fixefs <- apply(coef(obsdomf.m2.sim),2,get.hpd)
mean.time.effect <- mean(coef(obsdomf.m2.sim)[,3])

# remember to square the predictions to get the units back to domfreqrange kHz from\
# sqrt(domfreqrange)
single.domf <- (coef(obsdomf.m2.sim)[,1])^2
multi.domf <- (coef(obsdomf.m2.sim)[,1]+coef(obsdomf.m2.sim)[,2])^2
hpd.single.domf <- round(get.hpd(single.domf),2)
hpd.multi.domf <- round(get.hpd(multi.domf),2)

# the final expected multi-single rec-level difference in dB
hpd.multi.single.diff <- round(get.hpd(multi.domf-single.domf),2)
hpd.multi.single.relative <- round(get.hpd(multi.domf/single.domf),2)

# max and min effect of time :
max.min.time.effect <- quantile(obs_domfrange$centred_posix_minute,c(0.025,0.975))*mean.time.effect # in sqrt(kHz range)
squared.time.effect <- round(max.min.time.effect^2,2) # in kHz range


```
Time appears to some kind of effect, though it is indeed very small. For example, if we consider the 95%ile values of centred time, it suggests that time could contribute at most `r squared.time.effect[1]`-`r squared.time.effect[2]`kHz to the dominant frequency range. This range is not much in is not much in comparison to the contribution of the group status for instance. 



### Including virtual audio

```{r virt.domfrange, warning=F}
obsvirt_domfrange <- rbind(virt_domfrange,  obs_domfrange[,c('domfrange','group_status','sqrt.frange')])
obsdomf.m3 <- lm(sqrt.frange ~ as.factor(group_status) , data=obsvirt_domfrange)



par(mfrow=c(3,2))
plot(obsdomf.m3)
acf(resid(obsdomf.m3))

```

```{r sim.obsvirt.domfrange}


obsdomf.m3.sim <- sim(obsdomf.m3, n.sim=num_post)
m3.domf.hpd.fixefs <- apply(coef(obsdomf.m3.sim),2,get.hpd)
mean.time.effect <- mean(coef(obsdomf.m3.sim)[,3])

# remember to square the predictions to get the units back to domfreqrange kHz from\
# sqrt(domfreqrange)
single.domf <- (coef(obsdomf.m3.sim)[,1])^2
multi.domf <- (coef(obsdomf.m3.sim)[,1]+coef(obsdomf.m3.sim)[,2])^2
virt.domf <- (coef(obsdomf.m3.sim)[,1]+coef(obsdomf.m3.sim)[,3])^2

hpd.single.domf <- round(get.hpd(single.domf),2)
hpd.multi.domf <- round(get.hpd(multi.domf),2)
hpd.virt.domf <- round(get.hpd(virt.domf),2)

# the final expected multi-single rec-level difference in kHz
hpd.multi.single.diff <- round(get.hpd(multi.domf-single.domf),2)
hpd.multi.virt.diff <- round(get.hpd(multi.domf-virt.domf),2)

```

Here we see, that there is a clear increase in dominant frequency range in multi-bat audio of between `r hpd.multi.single.diff[1]`-`r hpd.multi.single.diff[2]` kHz.
The virtual multi-bat dominant frequency range matches that of the multi-bat range, and differs slightly between `r hpd.multi.virt.diff[1]`-`r hpd.multi.virt.diff[2]` kHz.

## Computational environment 

```{r, echo=TRUE,results=TRUE}
sessionInfo()
```

## References

